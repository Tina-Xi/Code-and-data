
##train BRT models##

rm(list=ls());
library(caret);
library(ggplot2);
library(nnet);
library(e1071);
library(ROCR)
library(RColorBrewer)
library(MLmetrics) #PRAUC
require(ggthemes)
require(coin)
require(plotrix)
library(raster)
library(dismo)
library(gbm)


timestart<-Sys.time();

filename=paste("South Asia.csv",sep='')
data <- read.csv(filename,header=T,encoding="utf-8")


data <- data[,1:15]
summary(data)
names(data) <- c('X',	'Y',	'Year',	'Precipitation',	'Temperature',	'Ethnic_Power_Relations','Gross_cell_product',	'Infant_mortality_rate',
                 'Land_cover', 'Water_resources','Crop_yield','Population_density','Altitude','Urban_accessibility','COVID-19',	'Conflict')


copy_Alldata <- data[,1:3]

temp_Alldata <- data[,4:16]

Alldata <- temp_Alldata



Accuracy_data <- c()

i = 1
for(i in 1 : 50){
  set.seed(i)
  
  Conflict_data_all<- subset(Alldata,Conflict == 1)
  noConflict_data_all<- subset(Alldata,Conflict != 1)
  
  rows_Conflict <- nrow(Conflict_data_all)
  rows_noConflict <- nrow(noConflict_data_all)
  proportion <- rows_Conflict/rows_noConflict
  
  samples_noConflict_size <- round(rows_noConflict*proportion);
  selectIndex <- sample(rows_noConflict, size=samples_noConflict_size);
  samples_noConflict_data <- noConflict_data_all[selectIndex, ]
  
  Conflict_data=rbind(Conflict_data_all,samples_noConflict_data)
  summary(Conflict_data)
  
  train.flag <- createDataPartition(y=Conflict_data$Conflict,p=1,list=FALSE)
  training <- Conflict_data[train.flag,]
  
  BRT_model <- gbm.step(data=training, gbm.x = 1:12, gbm.y = 13, tree.complexity = 4,learning.rate = 0.01, bag.fraction = 0.75, step.size = 10, cv.folds = 10, max.trees = 10000)
  
  pred <- predict.gbm(BRT_model, training, n.trees=BRT_model$n.trees, "response")
  pred <- data.frame(pred)
  names(pred) <- c("risk")

  PR_AUC<-PRAUC(y_pred = pred, y_true = training$Conflict)
  ###F1 score
  F1_pred <- ifelse(pred < 0.5, 0, 1)
  F1_score1 <- F1_Score(y_pred = F1_pred, y_true =training$Conflict, positive = "1")
  
  temp_auc_training <- BRT_model$cv.statistics$discrimination.mean
  
  temp_accuracy_data <- c()
  temp_accuracy_data <- cbind(temp_auc_training,PR_AUC,F1_score1)
  Accuracy_data <- rbind(Accuracy_data,temp_accuracy_data)
  
  modelname<-paste("South Asia_Non-state_",i,".Rdata",sep="")
  
  save(BRT_model, file = modelname)
  
  pred <-  predict.gbm(BRT_model, Alldata, n.trees=BRT_model$n.trees, "response")
  
  copy_Alldata$Risk <- pred
  simulate_filename <- paste("South Asia_Non-state_",i,".csv",sep="")
  write.csv(copy_Alldata, file=simulate_filename,row.names=F)
}
filename<-paste("South Asia_Non-state_accuracy.csv",sep="")
write.csv(Accuracy_data, file=filename)

timeend<-Sys.time()
runningtime<-timeend-timestart
print(runningtime)


